{% extends "base.html" %}
{% load static %}
{% block title %}
<title>Production View</title>
{% endblock %}


{% block head_style %}

<!-- 引入jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}


{% block content %}

<div class="row">
    <div class="col-md-7 mb-3" id="product-images">
    </div>

    <div class="col-md-5 mb-3">

        <h2>AI视觉外观缺陷检测系统</h2>
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="添加或选择产品批次" id="productioni-input" aria-label="Production">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">选择</button>
                <div class="dropdown-menu">
                    {% for production in production_list %}
                    <a class="dropdown-item production-option" href="#">{{ production.batch_number }}</a>
                    {% endfor %}

                </div>
            </div>

            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="">添加</button>
            </div>

            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="">开始</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="operatorId" class="form-label">操作员:</label>
                <input type="text" class="form-control" id="operatorId" placeholder="1">
            </div>
            <div class="col-md-6 mb-3">
                <label for="operationCount" class="form-label">合格率:</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="operationCount" placeholder="100">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="totalCount" class="form-label">设备速度:</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="totalCount" placeholder="100">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="defectiveCount" class="form-label">生产速度:</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="defectiveCount" placeholder="100">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col-md-6 mb-3">
                <label for="totalCount" class="form-label">合格数量:</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="totalCount" placeholder="100">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <button class="btn btn-secondary w-100" type="button" id="clear-btn" onclick="">清零</button>
            </div>
        </div>
        <img id="origin-image" src="https://placehold.co/600x300" alt="Camera Stream" class="img-fluid rounded">

    </div>
</div>

<div id="product-image-url" data-url="{% url 'productioin_images' %}" style="display: none;"></div>
{% endblock %}

{% block endscript %}
<script>
    var csrftoken = $("[name=csrfmiddlewaretoken]").val();

    function addImagesToDiv(data) {
        var $imagesDiv = $('#product-images'); // 获取div元素
        $imagesDiv.empty(); // 清空div中的现有内容

        data.forEach(function(photo) {
            // 为每个图片URL创建一个<img>元素并设置其src属性
            var $img = $('<img>').attr({
                src: photo.thumbnail,
                alt: photo.title,
                class: 'img-fluid thumbnail', // Bootstrap的响应式图片类
                'data-original-url': photo.url,
                'data-title': photo.title
            }).css({
                margin: '5px', // 设置图片间隔
                maxWidth: '100px', // 设置图片最大宽度，根据需要调整
                maxHeight: '100px' // 设置图片最大高度，根据需要调整
            });

            $img.on('click', function() {
                showOriginImage($(this).data('original-url'), $(this).data('title'));
            });
            // 将<img>元素添加到div中
            $imagesDiv.append($img);
            });
    }

    function showOriginImage(url, title) {
        $("#origin-image").attr("src", url);
        $("#origin-image").attr("alt", title);
    }

    function getLatestProductImages() {
        const url = $("#product-image-url").data("url");

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(data) {
                addImagesToDiv(data);
            },
            error: function(xhr, status, error) {
                console.error("An error occurred: " + error);
            }
        });
    }

    $(document).ready(function() {
        getLatestProductImages();
    });
</script>
{% endblock %}
