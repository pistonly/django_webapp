{% extends "base.html" %}
{% load static %}
{% block title %}
<title>Production View</title>
{% endblock %}


{% block head_style %}

<!-- 引入jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


{% endblock %}


{% block content %}

<div class="row">
    <div class="col-md-7 mb-3" id="product-images">
    </div>

    <div class="col-md-5 mb-3">

        <h2>AI视觉外观缺陷检测系统</h2>
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="添加或选择产品批次" id="production-input" aria-label="Production">

            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="">开始</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="input-group-text" id="">操作员:</span>
                    <input type="text" class="form-control" id="operatorId" placeholder="1">
                </div>
            </div>
            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="input-group-text" id="">合格率:</span>
                    <input type="text" class="form-control" id="operatorId" placeholder="1">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="input-group-text" id="">设备速度:</span>
                    <input type="text" class="form-control" id="dev-speed" placeholder="100">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>

            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="input-group-text" id="">生产速度:</span>
                    <input type="text" class="form-control" id="product-speed" placeholder="100">
                    <span class="input-group-text">PSC</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="input-group-text" id="">合格数量:</span>
                    <input type="text" class="form-control" id="pass-num" placeholder="100">
                </div>
            </div>
            <div class="col-md-6">
                <button class="btn btn-secondary w-100" type="button" id="clear-btn" onclick="">清零</button>
            </div>
        </div>
        <img id="origin-image" src="https://placehold.co/600x300" alt="Camera Stream" class="img-fluid rounded">

    </div>
</div>

<div id="product-image-url" data-url="{% url 'productioin_images' %}" style="display: none;"></div>
{% endblock %}

{% block endscript %}
<script>
    var csrftoken = $("[name=csrfmiddlewaretoken]").val();

    function addImagesToDiv(data) {
        var $imagesDiv = $('#product-images'); // 获取div元素
        $imagesDiv.empty(); // 清空div中的现有内容

        data.forEach(function(photo) {
            // 为每个图片URL创建一个<img>元素并设置其src属性
            var $img = $('<img>').attr({
                src: photo.thumbnail,
                alt: photo.title,
                class: 'img-fluid thumbnail', // Bootstrap的响应式图片类
                'data-original-url': photo.url,
                'data-title': photo.title
            }).css({
                margin: '5px', // 设置图片间隔
                maxWidth: '100px', // 设置图片最大宽度，根据需要调整
                maxHeight: '100px' // 设置图片最大高度，根据需要调整
            });

            $img.on('click', function() {
                showOriginImage($(this).data('original-url'), $(this).data('title'));
            });
            // 将<img>元素添加到div中
            $imagesDiv.append($img);
            });
    }

    function showOriginImage(url, title) {
        $("#origin-image").attr("src", url);
        $("#origin-image").attr("alt", title);
    }

    function getLatestProductImages() {
        const url = $("#product-image-url").data("url");

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(data) {
                addImagesToDiv(data);
            },
            error: function(xhr, status, error) {
                console.error("An error occurred: " + error);
            }
        });
    }

    $(document).ready(function() {
        getLatestProductImages();
    });
</script>


<script>
 $(document).ready(function() {
     var $input = $("#production-input");

     $input.autocomplete({
         source: function(request, response) {
             $.ajax({
                 url: "{% url 'search_batch_number' %}",
                 dataType: "json",
                 data: { term: request.term },
                 success: function(data) {
                     // Ensure the data is mapped to an array of objects with label and value
                     response($.map(data, function(item) {
                         return { label: item, value: item };
                     }));
                 }
             });
         }
     });
 });
</script>

{% endblock %}
